{{ 'component-minicart.css' | asset_url | stylesheet_tag }}
{{ 'component-minicart-item.css' | asset_url | stylesheet_tag }}
{{ 'component-minicart-upsell.css' | asset_url | stylesheet_tag }}

<script src="{{ 'vendor.js' | asset_url }}"></script>
<script src="{{ 'component-money-format.js' | asset_url }}"></script>
<script src="{{ 'minicart.js' | asset_url }}" defer></script>

{% assign title = section.settings.title %}
{% assign show_progress_bar = section.settings.show_progress_bar %}
{% assign free_threshold = section.settings.free_threshold %}
{% assign tier2_pairs = section.settings.tier2_pairs %}
{% assign tier2_discount = section.settings.tier2_discount %}
{% assign tier3_pairs = section.settings.tier3_pairs %}
{% assign tier3_discount = section.settings.tier3_discount %}
{% assign pair_product_types = section.settings.pair_product_types %}
{% assign shipping_text = section.settings.shipping_text %}
{% assign checkout_text = section.settings.checkout_text %}
{% assign show_upsell = section.settings.show_upsell %}
{% assign upsell_collection = section.settings.upsell_collection %}
{% assign upsell_limit = section.settings.upsell_limit | plus: 1 %}
{% assign upsell_title = section.settings.upsell_title %}
{% assign upsell_btn_text = section.settings.upsell_btn_text %}

<section class="minicart js-minicart {% if cart.item_count == 0 %}empty{% endif %}">
  <div class="minicart__container">
    <div class="minicart__wrapper">
      <header class="minicart__header">
        <h4 class="minicart__title">{{ title }}</h4>
        <button class="js-close-minicart minicart__btn-close" aria-label="Close Minicart">
          <img src="{{ 'icon-close.svg' | asset_url }}">
        </button>
      </header>

      <div class="minicart__empty">
        <h3>Cart is empty</h3>
      </div>

      <div class="minicart__body">
        {% if show_progress_bar %}
          <div class="minicart__tiers js-minicart-tiers"
               data-free-threshold="{{ free_threshold }}"
               data-tier2-pairs="{{ tier2_pairs }}"
               data-tier2-discount="{{ tier2_discount }}"
               data-tier3-pairs="{{ tier3_pairs }}"
               data-tier3-discount="{{ tier3_discount }}"
               data-pair-types="{{ pair_product_types }}">

            <div class="minicart__tier minicart__tier--shipping js-tier-shipping">
              <div class="minicart__tier-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/>
                  <path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"/>
                  <circle cx="7" cy="18" r="2"/>
                  <circle cx="17" cy="18" r="2"/>
                </svg>
              </div>
              <div class="minicart__tier-content">
                <p class="minicart__tier-text js-tier-shipping-text">Add <span class="js-shipping-remaining"></span> for FREE SHIPPING</p>
                <div class="minicart__tier-bar">
                  <div class="minicart__tier-bar-fill js-shipping-bar"></div>
                </div>
              </div>
              <div class="minicart__tier-check js-tier-shipping-check">âœ“</div>
            </div>

            <div class="minicart__tier minicart__tier--discount js-tier-discount">
              <div class="minicart__tier-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
              </div>
              <div class="minicart__tier-content">
                <p class="minicart__tier-text js-tier-discount-text">Add 1 more pair to save <span class="js-next-discount">20%</span></p>
              </div>
              <div class="minicart__tier-badge js-tier-discount-badge"></div>
            </div>

            <div class="minicart__tier-savings js-tier-savings" style="display: none;">
              <p class="minicart__savings-text">ðŸŽ‰ You're saving <span class="js-savings-percent"></span>!</p>
            </div>
          </div>
        {% endif %}

        <div class="js-minicart-items minicart__items"></div>

        <div class="minicart__checkout">
          <div class="minicart__subtotal">
            <p class="minicart__subtotal-text">
              Subtotal (<span class="js-cart-count">{{ cart.item_count }}</span> Item<span
                  class="js-cart-count-ending minicart__count-ending {% if cart.item_count > 1 %}active{% endif %}">s</span>)
            </p>
            <span class="js-minicart-subtotal-price minicart__subtotal-price">{{ cart.items_subtotal_price | money }}</span>
          </div>

          <div class="minicart__discount-line js-discount-line" style="display: none;">
            <p class="minicart__discount-text">Discount (<span class="js-discount-percent"></span>)</p>
            <span class="minicart__discount-amount js-discount-amount"></span>
          </div>

          <p class="minicart__checkout-shipping">{{ shipping_text }}</p>
          <a href="/checkout" class="minicart__checkout-button">
            {{ checkout_text }}
            <img class="minicart__checkout-button-chevron" src="{{ 'icon-chevron-right.svg' | asset_url }}">
          </a>
        </div>
      </div>
    </div>

    {% if show_upsell and upsell_collection != blank %}
      {% assign count = 0 %}
      <div class="minicart-upsell js-minicart-upsell"
           data-upsell-collection="{{ upsell_collection.handle }}">
        <h4 class="minicart__title minicart-upsell__title">{{ upsell_title }}</h4>

        <div class="minicart-upsell__items js-upsell-items">
          {% for product in upsell_collection.products %}
            {% if product.available %}
              {% assign count = count | plus: 1 %}

              {% if count < upsell_limit %}
                <div class="minicart-upsell-item" data-product-id="{{ product.id }}">
                  <div class="minicart-upsell-item__image-container">
                    <div class="minicart-upsell-item__image-wrapper">
                      <img
                          src="{{ product.featured_image | img_url: '100x' }}"
                          srcset="{{ product.featured_image | img_url: '100x' }} 1x, {{ product.featured_image | img_url: '200x' }} 2x"
                          alt="{{ product.title }}"
                          class="minicart-upsell-item__image"
                          loading="lazy"
                      >
                    </div>
                  </div>

                  <div class="minicart-upsell-item__meta">
                    <h5 class="minicart-upsell-item__title">{{ product.title }}</h5>
                    <p class="minicart-upsell-item__price">{{ product.price | money }}</p>

                    <div class="minicart-upsell-item__btn-group">
                      <div class="minicart-upsell-item__btn-wrapper">
                        <select
                            id="ProductSelect-{{ forloop.index0 }}"
                            data-index="option{{ forloop.index }}"
                            class="js-upsell-variant minicart-item__quantity minicart-upsell-item__select"
                            style="background-image: url('{{ 'icon-chevron-down-black.svg' | asset_url }}')"
                        >
                          <option value="" disabled selected>Select size</option>
                          {%- for variant in product.variants -%}
                            <option
                                {% if variant == current_variant %}selected="selected"{% endif %}
                                {% unless variant.available %}disabled="disabled"{% endunless %}
                                value="{{ variant.id }}">
                              {{- variant.option1 -}}
                            </option>
                          {%- endfor -%}
                        </select>
                      </div>

                      <div class="minicart-upsell-item__btn-wrapper">
                        <button class="js-upsell-btn minicart-upsell-item__btn">{{ upsell_btn_text }}</button>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}
    <div class="js-minicart-loader minicart__loader">
      <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
    </div>
  </div>
</section>


<div class="js-close-minicart js-minicart-overlay minicart__overlay"></div>
<div class="js-header-overlay header__overlay"></div>

{% schema %}
{
  "name": "Minicart",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Minicart title",
      "default": "My bag"
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "label": "Show savings tiers",
      "default": true
    },
    {
      "type": "header",
      "content": "Tier 1: Free Shipping"
    },
    {
      "type": "number",
      "id": "free_threshold",
      "label": "Free shipping threshold ($)",
      "default": 69
    },
    {
      "type": "header",
      "content": "Tier 2: Pair Discount"
    },
    {
      "type": "number",
      "id": "tier2_pairs",
      "label": "Number of pairs for Tier 2",
      "default": 2
    },
    {
      "type": "number",
      "id": "tier2_discount",
      "label": "Tier 2 discount percentage",
      "default": 20
    },
    {
      "type": "header",
      "content": "Tier 3: Bigger Discount"
    },
    {
      "type": "number",
      "id": "tier3_pairs",
      "label": "Number of pairs for Tier 3",
      "default": 3
    },
    {
      "type": "number",
      "id": "tier3_discount",
      "label": "Tier 3 discount percentage",
      "default": 25
    },
    {
      "type": "text",
      "id": "pair_product_types",
      "label": "Product types that count as pairs",
      "default": "Swoveralls,Swovie Shorts,Comfyalls",
      "info": "Comma-separated list of product types"
    },
    {
      "type": "text",
      "id": "shipping_text",
      "label": "Checkout shipping text",
      "default": "Shipping and taxes calculated at checkout."
    },
    {
      "type": "text",
      "id": "checkout_text",
      "label": "Checkout button text",
      "default": "GO TO CHECKOUT"
    },
    {
      "type": "header",
      "content": "Upsell"
    },
    {
      "type": "checkbox",
      "id": "show_upsell",
      "label": "Show upsell products",
      "default": true
    },
    {
      "type": "collection",
      "id": "upsell_collection",
      "label": "Upsell collection"
    },
    {
      "type": "range",
      "id": "upsell_limit",
      "label": "Upsell products limit",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 3
    },
    {
      "type": "text",
      "id": "upsell_title",
      "label": "Upsell title",
      "default": "Complete your look"
    },
    {
      "type": "text",
      "id": "upsell_btn_text",
      "label": "Upsell button text",
      "default": "Add to bag"
    }
  ]
}
{% endschema %}
