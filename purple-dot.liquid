{% comment %}
  PLEASE DO NOT EDIT THIS FILE: It's managed internally by Purple Dot.
{% endcomment %}

<style>
  {% if product.tags contains 'purple-dot-live-waitlist' %}
    #addToCartBtn {
      display: none;
    }
  
    .sticky-cart {
      display: none !important;
    }
  
    #pd-waitlist-info {
      font-size: 14px !important;
      margin: 0.875rem 0 !important;
      background: #FCFAF1 !important;
      border-radius: 4px;
      padding: 10px !important;
    }
  
    #pd-waitlist-info p {
      opacity: .8;
      margin: 10px 5px !important;
    }
  
    #pd-dispatch-date {
      opacity: 1;
      font-weight: bold;
    }
  {% endif %}
</style>

<script>
  window.PurpleDotConfig = {
    shopifyCart: {{ cart | json }},
    prefillEmail: '{{ customer.email }}',
    prefillShippingAddress: {{ customer.default_address | json }},
    enableWaitlists: () => {
      return new Promise((resolve, reject) => {
        fetch('/browsing_context_suggestions.json')
          .then(response => response.json())
          .then(data => {
            if (data?.detected_values?.country?.handle) {
              resolve(data.detected_values.country.handle === 'US' || data.detected_values.country.handle === 'CA');
            } else {
              resolve(true);
            }
          })
          .catch(error => {
            reject(error);
          });
      });
    },
    // Temp fix for physical-device-only ATC bug
    onProductPageWithWaitlist: (ctx, { waitlist }) => {
      if (!waitlist) return;
      
      const form = document.querySelector('form[action*="/cart"]');
      const getState = (classList) => {
        const state = classList.value.split(' ').find(item =>
          item.includes('instock') || item.includes('soldout') || item.includes('preorder')
        );
        
        if (state.includes('instock')) {
          return 'Add to cart';
        } else if (state.includes('soldout')) {  
          return 'Sold out';
        } else if (state.includes('preorder')) {
          return 'Pre-order'
        } else {
          return null;
        }
      }
    
      new MutationObserver((m, o) => {
        const mutatedForm = document.querySelector('form[action*="/cart"]');
        const button = mutatedForm.querySelector('#addToCartBtn');
        const state = getState(mutatedForm.classList);

        if(!state) return;

        o.disconnect();
        console.log('pd: getState -->', state);
        button.innerHTML = state;
        o.observe(form, { attributes: true, childList: true, subtree: true });
      }).observe(form, { attributes: true, childList: true, subtree: true });
    }
  };
</script>
<script src="https://www.purpledotprice.com/api/v1/init.js?apiKey={{settings.purpledot_api_key}}"></script>